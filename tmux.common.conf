# This file holds common settings between tmux and byobu-tmux.
# It gets sourced by ~/.tmux.conf and ~/.byobu/.tmux.conf.
#
# TODO: select windows using alt-NR

# set -g default-terminal "screen-256color"

# Enable mouse support
# mouse-mode: on allows scrolling, but requires Shift for X-selection (copy-mode does not)
# set -g mode-mouse copy-mode
set -g mode-mouse on
set -g mouse-resize-pane on
set -g mouse-select-pane on
set -g mouse-select-window on
set -g mouse-utf8 on

# toggle mouse mode to allow mouse copy/paste
# set mouse on with prefix m
bind m \
    set -g mode-mouse on \;\
    set -g mouse-resize-pane on \;\
    set -g mouse-select-pane on \;\
    set -g mouse-select-window on \;\
    display 'Mouse: ON'
# set mouse off with prefix M
bind M \
    set -g mode-mouse off \;\
    set -g mouse-resize-pane off \;\
    set -g mouse-select-pane off \;\
    set -g mouse-select-window off \;\
    display 'Mouse: OFF'

# via http://robots.thoughtbot.com/post/2641409235/a-tmux-crash-course
# Use C-a and ^ as prefixes.
unbind C-b
set -g prefix C-a
set -g prefix2 ^
bind ^ send-prefix -2
# bind C-a send-prefix
# bind C-A send-prefix \; send-prefix

# send prefix to tmux in tmux
bind a send-prefix
bind -n C-^ send-prefix

# easy reloading of config
bind R source-file ~/.tmux.conf \; display "Reloaded!"

bind C-a last-window
bind -r Tab select-pane -t :.+
bind -r S-Tab select-pane -t :.-

# via http://jasonwryan.com/blog/2011/06/07/copy-and-paste-in-tmux/
unbind [
bind Escape copy-mode
# unbind p
bind P paste-buffer
bind-key -t vi-copy 'v' begin-selection
# Yank to tmux buffer and X11 selection.
bind-key -t vi-copy 'y' copy-pipe "xsel -i --primary"
# tmux buffer <-> clipboard interaction
bind C-c run "tmux show-buffer | xsel -i --clipboard" \; display 'Copied..'
bind C-v run "tmux set-buffer -- \"$(xsel -o --clipboard)\"; tmux paste-buffer"


set-option -g display-time 4000
set-option -g display-panes-time 4000
# time for repeating of a hotkey bound using the -r flag without having to type the prefix again; default: 500
set-option -g repeat-time 1000

# Resize the window to the size of the smallest session for which it is the
# current window, rather than the smallest session to which it is attached.
set-window-option -g aggressive-resize on

set -g history-limit 10000

# Terminal emulator window title
set -g set-titles on
# Use hostname (@#h) in set-titles-string with SSH.
if-shell 'test -n "$SSH_CLIENT"' 'set -g set-titles-string "[tmux: #S:#I.#P @#h] #T"' 'set -g set-titles-string "[tmux: #S:#I.#P] #T"'

# Config for vim-like movements; based on https://github.com/sdball/dotfiles/blob/master/.tmux.conf
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Switch panes with Alt-Left/Right/Up/Down
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# do not allow for repeating (-r, default; distracts with shell history)
bind-key Up select-pane -U

# vim movement keys for switching windows
bind -r C-H select-window -t :-
bind -r C-L select-window -t :+

# use 1 as base for windows/panes
set -g base-index 1
set -g pane-base-index 1

# select windows via Alt-NR
bind -n M-1 select-window -t :1
bind -n M-2 select-window -t :2
bind -n M-3 select-window -t :3
bind -n M-4 select-window -t :4
bind -n M-5 select-window -t :5
bind -n M-6 select-window -t :6
bind -n M-7 select-window -t :7
bind -n M-8 select-window -t :8
bind -n M-9 select-window -t :9
bind -n M-0 select-window -t :0

# select panes using Alt-Q/W/E/R/T
bind -n M-q select-pane -t :.1
bind -n M-w select-pane -t :.2
bind -n M-e select-pane -t :.3
bind -n M-r select-pane -t :.4
bind -n M-r select-pane -t :.5

# vim movement keys for resizing panes
# bind -r H resize-pane -L 5
# bind -r J resize-pane -D 5
# bind -r K resize-pane -U 5
# bind -r L resize-pane -R 5

bind  H swap-window -t -1
bind  L swap-window -t +1
bind  J swap-pane -D
bind  K swap-pane -U

# vi mode
setw -g mode-keys vi # vim movement keys for switching panes

# # enable maximizing panes
# NOTE: `resize-pane -Z` is available with tmux 1.8 (bound to "z")
# bind S-Up new-window -d -n tmp \; swap-pane -s tmp.0 \; select-window -t tmp
# bind S-Down last-window \; swap-pane -s tmp.0 \; kill-window -t tmp

# Activity Monitoring
# b/B: set/unset bell
bind b setw monitor-activity on
bind B setw monitor-activity off
set -g visual-activity on
set -g visual-content on
set -g visual-bell off  # default

# Sets urgent flag for window manager.
set -g bell-action on  # default
set -g bell-on-alert on

# Sane scrolling, via: http://superuser.com/a/326592/30216
# set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# do not make Esc+key behave like Alt-key
set -s escape-time 0

# Smart pane switching with awareness of vim splits
# Source: https://github.com/christoomey/vim-tmux-navigator
# TODO: also grep for "view"
bind -n C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys C-h) || tmux select-pane -L"
bind -n C-j run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys C-j) || tmux select-pane -D"
bind -n C-k run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys C-k) || tmux select-pane -U"
bind -n C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys C-l) || tmux select-pane -R"
bind -n C-\ run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim(diff)?$' && tmux send-keys 'C-\\') || tmux select-pane -l"

# restore original C-l
bind C-l send-keys 'C-l'

# Powerline
source ~/.dotfiles/lib/powerline/powerline/bindings/tmux/powerline.conf

# # Powerline overrides (#T):
# Default:
# set -g window-status-format "#[fg=colour244,bg=colour234]#I #[fg=colour240] #[default]#W "
# set -g window-status-current-format "#[fg=colour234,bg=colour31]#[fg=colour117,bg=colour31] #I  #[fg=colour231,bold]#W #[fg=colour31,bg=colour234,nobold]"

# - add #F
# - use #T (term/pane title)
set -g window-status-format "#[fg=colour244,bg=colour234]#I#F#[fg=colour240] #[default]#30T "
set -g window-status-current-format "#[fg=colour234,bg=colour31]#[fg=colour117,bg=colour31] #I#F #[fg=colour231,bold]#50T #[fg=colour31,bg=colour234,nobold]"


# tmuxstart; like tmuxinator/teamocil, but more inception-like
bind S command-prompt -p "Make/attach session:" "new-window 'tmuxstart \'%%\''"
